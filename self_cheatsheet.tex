% Copyright (c) 2016 Bystroushaak

% Permission is hereby granted, free of charge, to any person
% obtaining a copy of this software and associated documentation
% files (the "Software"), to deal in the Software without
% restriction, including without limitation the rights to use,
% copy, modify, merge, publish, distribute, sublicense, and/or sell
% copies of the Software, and to permit persons to whom the
% Software is furnished to do so, subject to the following
% conditions:

% The above copyright notice and this permission notice shall be
% included in all copies or substantial portions of the Software.

% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
% EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
% OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
% NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
% HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
% WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
% FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
% OTHER DEALINGS IN THE SOFTWARE.

% Inspired by http://tex.stackexchange.com/questions/99765/document-class-for-reference-cards
\documentclass[10pt]{article}
\usepackage{fixltx2e}
\usepackage[orthodox,l2tabu,abort]{nag}
\usepackage{textcomp}
\usepackage{hyperref}

% Page layout
\usepackage[landscape,margin=0.5in]{geometry}
\usepackage{multicol}

% Title area
\usepackage{titling} % Allows for use of date, author, etc. after \maketitle
% Ref: http://tex.stackexchange.com/questions/3988/titlesec-versus-titling-mangling-thetitle
\let\oldtitle\title
\renewcommand{\title}[1]{\oldtitle{#1}\newcommand{\mythetitle}{#1}}
\renewcommand{\maketitle}{
    {\begin{center}\Large \mythetitle\end{center}}
}

% Document divisions
\usepackage{titlesec}
\setcounter{secnumdepth}{0}
\titlespacing{\section}{0pt}{0pt}{0pt}
\titlespacing{\subsection}{0pt}{3pt}{0pt}
\titlespacing{\subsubsection}{0pt}{0pt}{0pt}
\setlength{\parskip}{2pt}

\usepackage{nopageno} % To keep \section from resetting page style
\setlength{\parindent}{0pt} % disabling indentation by default

% Lists
\usepackage{enumitem} % for consistent formatting of lists
\newlist{ttdesc}{description}{1}
\setlist[ttdesc]{font=\ttfamily,noitemsep}
\usepackage{calc} % for \widthof

\usepackage{lipsum}

% Metadata definition
\title{Selflang cheat sheet}
\author{Bystroushaak}
\date{2016}

\pdfinfo {
    /Author   (\theauthor)
    /Title    (\thetitle)
    /Subject  (\thetitle)
    /Keywords (Self, SelfLang, programming language, programming)
}


% Set listing
% https://en.wikibooks.org/wiki/LaTeX/Source_Code_Listings
\usepackage{listings}
\usepackage{pxfonts}

\lstset{
    basicstyle=\ttfamily,
    keywordstyle=\bfseries,
    showstringspaces=false,
    breaklines=false,
    breakatwhitespace=false,
    columns=fullflexible,
}


% Content =====================================================================
\begin{document}
\begin{multicols*}{3}
\maketitle

\section{Object syntax}

An \textit{object} consists from (possibly empty) set of \textit{slots} and (optionally) \textit{code}.

Slots behave as key-value lookup table for data or objects. \textit{Code} is a sequenece of \textit{expressions} (\textit{message sends} and \textit{literals}) separated by dots, and evaluated in order.

Syntax is straightforward:

\begin{lstlisting}
(| slot1. slot2 | 'code' printLine. 'str')
\end{lstlisting}

for object with \textit{slots} and \textit{code}, or

\begin{lstlisting}
(| | 'this is str') or ('this is str')
\end{lstlisting}

for object with \textit{code}, but no \textit{slots}, or

\begin{lstlisting}
(| slot1. slot2. slotN |)
\end{lstlisting}

for object with \textit{slots}, but no \textit{code}, or

\begin{lstlisting}
(| |) or ()
\end{lstlisting}

for empty object.



\subsection{Comments}

Comments use double quotes and are ignored by parser. See \textit{Annotations slots} in subsection \textit{Special slots}.

\begin{lstlisting}
("empty object")
\end{lstlisting}




\subsection{Slot assignments}

Slots can be assigned at the definition, either read only using \texttt{=} operator:

\begin{lstlisting}
(| slot = 1 |)
\end{lstlisting}

or rewritable using \texttt{<-} operator: % TODO: operator, really?

\begin{lstlisting}
(| slot <- 1 |)
\end{lstlisting}




\subsection{Messages}

\textit{Messages} are evaluated from left to right. Object is on the left, messages on the right. Messages can be without arguments:

\begin{lstlisting}
obj message
\end{lstlisting}

(to the \textit{obj} send a \textit{message}), or with arguments:

\begin{lstlisting}
obj message: argument
\end{lstlisting}

(to the \textit{obj} send a \textit{message} with \textit{argument} as value).




\subsection{Special slots}

\subsubsection{\texttt{self} slot}
Every object has automatically created slot named \texttt{self}, pointing to object itself. Unlike other languages, \texttt{self} may be ommited, in \textit{message sends}, so

\begin{lstlisting}
self message
\end{lstlisting}

is same thing as

\begin{lstlisting}
message
\end{lstlisting}


\subsubsection{Annotation slot}

Description comments may be provided in the \textit{annotation slot}:

\begin{lstlisting}
(| {} = 'Annotation string.' |)
\end{lstlisting}

or

\begin{lstlisting}
(| { 'Annotation string.' slot. another. } |)
\end{lstlisting}


\subsubsection{\texttt{parent*} slot}
Every object may also contain \texttt{parent*} slot (star is mandatory), to which the lookups unresolved in \texttt{self} slot is delegated. This implements the inheritance.




\subsection{Method slots}

\textit{Method slots} is the storage for the code in objects.

\subsubsection{Unary slots}
Code \textit{slots} without arguments are called \textit{unary}.

\begin{lstlisting}
(| first = (printLine) |)
\end{lstlisting}

This \textit{method slot} can be invoked by sending \textit{unary} message:

\begin{lstlisting}
obj first
\end{lstlisting}



\subsubsection{Binary slots}

Slots with one argument is called \textit{binary}:

\begin{lstlisting}
(| first: = (| :arg | arg printLine) |)
\end{lstlisting}

Which has shorter equivalent:

\begin{lstlisting}
(| first: arg = (arg printLine) |)
\end{lstlisting}

Invocation is possible using the \textit{binary message}:

\begin{lstlisting}
obj first: 1
\end{lstlisting}

\textit{Binary slots} are also used as operators (one or more characters from \texttt{!@\#\$\%\^{}\&*-+=\textasciitilde/?\textless\textgreater,;|'\textbackslash{}} set).



\subsubsection{Keyword slots}

It is also possible to create \textit{keyword} slots with multiple arguments:

\begin{lstlisting}
(| first: x Second: y = (x + y printLine.) |)
\end{lstlisting}

Notice the uppercase \textit{S} in \texttt{Second}. Invocation is done via \textit{keyword message}:

\begin{lstlisting}
obj first: 3 Second: 5
\end{lstlisting}



\subsubsection{Priorities}

Constant definition \textgreater{} Unary \textgreater{} Binary \textgreater{} Keyword messages. Constant = self \textbar{} number \textbar{} string \textbar{} object.




\subsection{Block objects \textit{(closures)}}

\textit{Block objects} share syntax with \textit{objects}, except that square brackts are used instead of round:

\begin{lstlisting}
[| slot1. slot2 | 'code']
\end{lstlisting}

\textit{Block objects} work as closures, which means, that \texttt{self} slot is not present. Unresolved lookups are delegated via \texttt{parent*} to namespace surrounding the \textit{block object} at the time of creation.

Another difference is support of \textit{non-local return statement} using \texttt{\^} preceding the returned value. This returns the value not just from the closure, but also from the enclosing namespace.

\begin{lstlisting}
(|
    x = 6.
    non_zero = (x > 5 ifTrue: [ ^ 'ok' ]
                         False: [ ^ 'nope' ])
|)
\end{lstlisting}

\^{} doesn't just return from the closure in \texttt{[]}, but also from the surrounding \textit{method object}.


\subsubsection{Block messages}

\textit{Block objects} take by default message \texttt{value}, which evaluates the code and returns the value.

If the \textit{block object} takes (multiple) parameters, they may be supplied using \texttt{value:\ With:} message pattern:

\begin{lstlisting}
block_obj value: x With: y .. With: z
\end{lstlisting}

Notice the upper-case first letters in \texttt{With:} message, which tells the Self interpreter, that this is still part of one message send, with multiple arguments.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\pagebreak %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Namespaces}

\subsection{Traits}
Objects with shared behaviour, which is used by pointing \texttt{parent*} slots to them. This is analogical to \textit{sub-classing} in other languages.



\subsection{Mixins}

Small objects filled with shared code. This code doesn't contain \texttt{parent*} slot, and it is thus not directly part of the OOP tree. Approximate analogy to other languages would be interface with implementation.



\subsection{Globals}
Prototype objects and \textit{oddballs} (unique singletons) like \texttt{true}, \texttt{false}, \texttt{nil}..


\section{Resends}

\textit{Resends} allows you to delegate the messages to the parent branches of OOP tree. Resend messages are equivalent of \textit{super} calls in other languages.

Syntactically, \textit{resends} are implemented using \textit{resend.} prefix for resent messages:

\begin{lstlisting}
resend.unary
resend.+ 1
resend.keyword: 1 Another: 2
\end{lstlisting}

You may also use \textit{directed resends}, targeting specific parent:

\begin{lstlisting}
intParent.+ 1
otherParent.keyword: 1 Another: 2
\end{lstlisting}

\section{Control sequences}
\subsection{If condition}

As usual in Smalltalk-like languages, \textit{if condition} is implemented as everything else by sending messages, in this case to boolean (or boolean traits) objects:

\vspace*{0.2cm}

\small{
\begin{tabular}{ p{70pt} p{140pt} l l }
Command & Description \\ \hline

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{lstlisting}
obj ifTrue: b
\end{lstlisting}
&\vspace*{0.25cm}

Execute \texttt{b} if the \textit{obj} is \texttt{true}.

\\\hline %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{lstlisting}
obj ifFalse: b
\end{lstlisting}
&\vspace*{0.25cm}

Execute \texttt{b} if the \textit{obj} is \texttt{false}.

\\\hline %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{lstlisting}
obj ifTrue: b1
     False: b2
\end{lstlisting}
&\vspace*{0.1cm}

\textit{b1} is executed, when \textit{obj} evaluates to \texttt{true}.
If not, (optional) \textit{b2} block is used.

\\\hline %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{lstlisting}
obj ifFalse: b1
     True: b2
\end{lstlisting}
&\vspace*{0.4cm}

Opposite of previous.

\\\hline %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\end{tabular}
}




% Footer
\vfill \hrule\smallskip

{\small
This card may be freely distributed under
the terms of the MIT licence ---
Copyleft \textcopyleft\ \thedate{} \href{http://kitakitsune.org}{\theauthor}. Version 1.0.

\url{https://github.com/Bystroushaak/SelfCheatSheet}
}

\end{multicols*}
\end{document}
